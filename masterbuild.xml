<?xml version="1.0" encoding="UTF-8"?>
<project name="masterbuild">

	<!-- Start of Global Properties -->

	<!-- Java class names of three MQSI commands -->
	<property name="mqsi.applybaroverride" value="com.ibm.broker.config.util.ApplyBarOverride" />
	<property name="mqsi.packagebar" value="com.ibm.broker.config.appdev.FlowRendererBAR" />
	<property name="mqsi.readbar" value="com.ibm.broker.config.util.ReadBar" />

	<!-- Create build start time stamp -->

	<tstamp>
		<format property="time.stamp" pattern="yyyy-MM-dd'T'HH:mm:ss" />
	</tstamp>

	<!-- End of Global Properties -->

	<target name="cleanup" description="Deletes compiled bar files for this specific application or project." unless="${deploy.only}">
		<echo message="CLEANUP target is starting ...${line.separator}" />
		<delete failonerror="false" verbose="true">
			<fileset dir="${barfile.dir}" includes="**/${iib.bar}*.bar" />
		</delete>
	</target>

	<target name="compile" depends="cleanup" description="Empty COMPILE target. Must be overriden in importing file." unless="${deploy.only}">
	</target>

	<target name="override" description="Overrides properties of the built BAR file using the mqsiapplybaroverride command.
		The new property values are read from an overrides file." unless="${deploy.only}">
		<echo message="OVERRIDE target starting ...${line.separator}" />
		<echo message="Command line: java -cp ... ${mqsi.applybaroverride} ${mqsi.applybaroverride.parameters}${line.separator}" />
		<java classname="com.ibm.broker.config.util.ApplyBarOverride" failonerror="true" fork="true">
  		<arg line="${mqsi.applybaroverride.parameters} -runtime" />
  		<classpath>
   			<fileset dir="${iib.path}${file.separator}server${file.separator}classes">
    				<include name="*.jar"/>
   			</fileset>
			<fileset dir="${iib.path}${file.separator}common${file.separator}classes">
				<include name="*.jar"/>
			</fileset>
  		</classpath>
 		</java>
	</target>

	<target name="deploy" depends="compile,override"
		description="Uses the mqsideploy command to deploy the compiled BAR file to the integration node specified in an XML file that is compliant with the broker.xsd schema.">
		<echo message="DEPLOY target starting ...${line.separator}" />
		<echo message="Command line: ${mqsi.deploy} ${mqsi.deploy.parameters}${line.separator}" />
		<exec executable="${iib.path}${file.separator}server${file.separator}bin${file.separator}${mqsi.deploy}" failonerror="true">
			<arg line="${mqsi.deploy.parameters}" />
		</exec>
	</target>

	<target name="test" depends="deploy" description="Empty TEST target. Must be overriden in importing file.">
	</target>

	<target name="run.test" depends="multiDeploy"
		description="Uses the SoapUI testrunner command to execute a SoapUI Test Project">
		<echo message="RUN.TEST target starting ...${line.separator}" />
		<echo message="Command line: ${soapui.exec} ${soapui.parameters}${line.separator}" />
		<exec executable="${soapui.exec}" failonerror="true">
			<arg line="${soapui.parameters}" />
		</exec>
	</target>

	<target name="read.bar" depends="compile" description="Reads a bar file and lists all its properties that can be overridden.">
		<echo message="READ.BAR target starting ...${line.separator}" />
		<echo message="Command line: java -cp ... ${mqsi.readbar} ${mqsi.readbar.parameters}${line.separator}" />
 		<java classname="com.ibm.broker.config.util.ReadBar" failonerror="true" fork="true">
  		<arg line="${mqsi.readbar.parameters} -runtime" />
  		<classpath>
   			<fileset dir="${iib.path}${file.separator}server${file.separator}classes">
    				<include name="*.jar"/>
   			</fileset>
			<fileset dir="${iib.path}${file.separator}common${file.separator}classes">
				<include name="*.jar"/>
			</fileset>
  		</classpath>
 		</java>
	</target>

	<target name="package.bar" description="Packages a bar file by adding pre-compiled resources to it.">
		<echo message="PACKAGE.BAR target starting ...${line.separator}" />
		<echo message="Command line: java -cp ... ${mqsi.packagebar} ${mqsi.packagebar.parameters}${line.separator}" />
 		<java classname="com.ibm.broker.config.appdev.FlowRendererBAR" failonerror="true" fork="true">
  		<arg line="${mqsi.packagebar.parameters}" />
  		<classpath>
   			<fileset dir="${iib.path}${file.separator}server${file.separator}classes">
    				<include name="*.jar"/>
   			</fileset>
			<fileset dir="${iib.path}${file.separator}common${file.separator}classes">
				<include name="*.jar"/>
			</fileset>
  		</classpath>
 		</java>
	</target>

<macrodef name="mdeploy">

	<attribute name="inode" />
	<attribute name="hostname" default="localhost"/>
	<attribute name="port" default="4414" />
	<attribute name="barfile" default="${iib.barfile.param}" />
	<attribute name="execgroup" default="${iib.svr}"/>

	<sequential>
		<echo message="MULTI.DEPLOY target starting ...${line.separator}" />
		<echo message="Command line: ${iib.path}${file.separator}server${file.separator}bin${file.separator}${mqsi.deploy} @{inode} -i @{hostname} -p @{port} -a @{barfile} -e @{execgroup} -m${line.separator}" />
		<exec executable="${iib.path}${file.separator}server${file.separator}bin${file.separator}${mqsi.deploy}" failonerror="true">
			<arg line="@{inode} -i @{hostname} -p @{port} -a @{barfile} -e @{execgroup} -m" />
		</exec>
	</sequential>
</macrodef>

	<!-- TODO. The deployed BAR file to be copied to an object store -->

</project>
